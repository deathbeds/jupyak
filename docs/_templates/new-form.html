<style>
    #propose textarea {
        width: 100%;
        min-height: 10rem;
        margin-top: 1rem;
        font-family: monospace;
    }
</style>
<form id="propose" method="get" action="https://github.com/deathbeds/jupyak/new/main" target="_blank">
    <button class="btn btn-success" form="propose">
        <i class="fas fa-code-pull-request"></i> New Pull Request
    </button>
    <div>
        <label for="toml-preview"><code>jupyak_config.toml</code> contents</label>
        <textarea
            id="toml-preview"
            name="value"
            spellcheck="false"
        ># make choices in the form</textarea>
        <input type="hidden" name="filename" value="jupyak_config.toml"/>
    </div>
</form>
<script type="importmap">
{
    "imports": {
        "json2toml": "https://cdn.skypack.dev/pin/json2toml@v6.0.0-d8Y8va9lNUE85BZ5GSQ2/mode=imports,min/optimized/json2toml.js"
    }
}
</script>
<script type="module">
    document.addEventListener('DOMContentLoaded', async () => {
        const form = document.querySelector('form#new');
        const preview = document.querySelector('#toml-preview');
        const selector = 'form#new input[type="text"], form#new textarea'
        const inputs = [...document.querySelectorAll(selector)];
        const split_fields = ['merge_with'];
        async function update() {
            const json2toml = (await import('json2toml')).default;
            const config = find_config();
            preview.value = json2toml(config);
        }
        function find_config() {
            const config = {};
            const data = new FormData(form);
            for (const [name, value] of data.entries()) {
                let bits = name.split("|");
                if(value.trim() === "" || bits.length == 1){
                    continue;
                }
                let current = config;
                for(const bit of bits.slice(0, -1)) {
                    if(!current[bit]) {
                        current[bit] = {};
                    }
                    current = current[bit];
                }
                let last_bit = bits[bits.length - 1];
                current[last_bit] = split_fields.includes(last_bit) ? value.split("\n") : value;
            }
            return config;
        }
        inputs.map((input) => input.addEventListener('input', update))
    })

</script>
